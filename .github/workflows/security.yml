name: 'Security'

# ----------------------------------------------------------------------------------
# ğŸ“¦ Security Workflow for Node.js Projects
#
# This workflow ensures supply chain security and dependency hygiene by:
# 1. Running GitHub's official Dependency Review on pull requests
#    - Detects and flags known-vulnerable packages added in PRs.
#    - Optionally comments on the PR with a summary.
# 2. Running `pnpm audit` and `better-npm-audit` on push/PR to critical branches
#    - Ensures no critical/moderate vulnerabilities are introduced in dependencies.
#
# ğŸ” Triggers:
# - On push to: main, dev, staging
# - On pull requests targeting: main, dev, staging
# - Can be called as reusable workflow from other repositories
#
# ğŸ” Related Docs:
# - Dependency Review: https://github.com/actions/dependency-review-action
# - Dependency Submission API: https://docs.github.com/en/enterprise-cloud@latest/code-security/supply-chain-security/using-the-dependency-submission-api
# - Better Audit: https://github.com/IBM/better-npm-audit
# ----------------------------------------------------------------------------------

on:
  push:
    branches: [main, dev, staging]
  pull_request:
    branches: [main, dev, staging]
  
  # Allow being called as reusable workflow from other repos
  workflow_call:
    inputs:
      pnpm_version:
        description: 'pnpm version to use'
        required: false
        type: string
        default: '8'
      audit_level:
        description: 'Audit severity level (low, moderate, high, critical)'
        required: false
        type: string
        default: 'moderate'
      dependency_review_severity:
        description: 'Dependency review fail threshold (low, moderate, high, critical)'
        required: false
        type: string
        default: 'moderate'
      comment_summary:
        description: 'Post dependency review summary as PR comment'
        required: false
        type: string
        default: 'always'
      skip_better_audit:
        description: 'Skip better-npm-audit check'
        required: false
        type: boolean
        default: false
    secrets:
      GITHUB_TOKEN:
        required: false

# Permissions required for this workflow to operate correctly
permissions:
  contents: read
  # Required to allow posting audit summaries as PR comments
  pull-requests: write

jobs:
  # --------------------------------------
  # ğŸ” GitHub Dependency Review (Pull Requests Only)
  #
  # This job analyzes manifest file diffs and detects any added/updated dependencies
  # with known vulnerabilities. Works only on PRs.
  # --------------------------------------
  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: ${{ inputs.comment_summary || 'always' }}
          fail-on-severity: ${{ inputs.dependency_review_severity || 'moderate' }}

  # --------------------------------------
  # ğŸ›¡ï¸ pnpm Audit & better-npm-audit
  #
  # Runs on push and PR events. Performs security audits of the dependency tree
  # using both native `pnpm audit` and IBM's `better-npm-audit` for deeper checks.
  # --------------------------------------
  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ inputs.pnpm_version || '8' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.4.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run security audit
        run: pnpm audit --audit-level ${{ inputs.audit_level || 'moderate' }}

      - name: Check for known vulnerabilities
        if: ${{ !inputs.skip_better_audit }}
        run: npx better-npm-audit audit --level ${{ inputs.audit_level || 'moderate' }}