name: 'Security'

# ----------------------------------------------------------------------------------
# 📦 Security Workflow for pnpm Projects
#
# This workflow ensures supply chain security using pnpm-native tools:
# 1. GitHub Dependency Review on pull requests
# 2. pnpm audit for vulnerability scanning
# 3. audit-ci for enhanced security checks (pnpm compatible)
#
# 🔁 Triggers:
# - On push to: main, dev, staging
# - On pull requests targeting: main, dev, staging
# - Can be called as reusable workflow from other repositories
# ----------------------------------------------------------------------------------

on:
  push:
    branches: [main, dev, staging]
  pull_request:
    branches: [main, dev, staging]
  
  # Allow being called as reusable workflow from other repos
  workflow_call:
    inputs:
      pnpm_version:
        description: 'pnpm version to use'
        required: false
        type: string
        default: '8'
      audit_level:
        description: 'Audit severity level (low, moderate, high, critical)'
        required: false
        type: string
        default: 'moderate'
      dependency_review_severity:
        description: 'Dependency review fail threshold (low, moderate, high, critical)'
        required: false
        type: string
        default: 'moderate'
      comment_summary:
        description: 'Post dependency review summary as PR comment'
        required: false
        type: string
        default: 'always'
      skip_better_audit:
        description: 'Skip better npm-audit check'
        required: false
        type: boolean
        default: false
jobs:
  # --------------------------------------
  # 🔍 GitHub Dependency Review (Pull Requests Only)
  # --------------------------------------
  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v4

      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          comment-summary-in-pr: ${{ inputs.comment_summary || 'always' }}
          fail-on-severity: ${{ inputs.dependency_review_severity || 'moderate' }}

  # --------------------------------------
  # 🛡️ pnpm Security Audit
  # --------------------------------------
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ inputs.pnpm_version || '8' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.4.x'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run pnpm security audit
        run: |
          echo "🔍 Running pnpm security audit..."
          pnpm audit --audit-level ${{ inputs.audit_level || 'moderate' }}

      - name: Check for known vulnerabilities
        if: ${{ !inputs.skip_better_audit }}
        run: npx better-npm-audit audit --level ${{ inputs.audit_level || 'moderate' }}